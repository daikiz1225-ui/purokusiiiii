const http = require('http');
const https = require('https');
const url = require('url');

module.exports = async (req, res) => {
    // 1. URLã®è§£æ
    const parsedUrl = url.parse(req.url, true);
    const queryUrl = parsedUrl.query.url;

    // --- A: URLã®æŒ‡å®šãŒãªã„å ´åˆ (æœ€åˆã®å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º) ---
    if (!queryUrl) {
        res.setHeader('Content-Type', 'text/html; charset=UTF-8');
        return res.status(200).send(`
            <!DOCTYPE html>
            <html lang="ja">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Node Proxy</title>
                <style>
                    body { background: #121212; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
                    .container { background: #1e1e1e; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 85%; max-width: 500px; text-align: center; }
                    input { width: 100%; padding: 15px; border-radius: 30px; border: none; outline: none; margin-bottom: 20px; font-size: 16px; box-sizing: border-box; }
                    button { background: #0055ff; color: white; border: none; padding: 15px 40px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 16px; width: 100%; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>ğŸŒ Node Proxy</h1>
                    <input type="text" id="target" placeholder="google.com" spellcheck="false">
                    <button onclick="go()">ã‚µã‚¤ãƒˆã¸ç§»å‹•</button>
                </div>
                <script>
                    function go() {
                        const val = document.getElementById('target').value;
                        if(!val) return;
                        // URLã‚’æ•´ãˆã‚‹ï¼ˆhttps:// ãŒãªã‘ã‚Œã°è¶³ã™ï¼‰
                        let targetUrl = val.startsWith('http') ? val : 'https://' + val;
                        // ã€è¶…é‡è¦ã€‘Vercelã®APIãƒ‘ã‚¹ã«åˆã‚ã›ã¦é£›ã°ã™
                        const encoded = btoa(encodeURIComponent(targetUrl));
                        window.location.href = '/api/proxy?url=' + encoded;
                    }
                    document.getElementById('target').onkeydown = (e) => { if(e.key === 'Enter') go(); };
                </script>
            </body>
            </html>
        `);
    }

    // --- B: URLã®æŒ‡å®šãŒã‚ã‚‹å ´åˆ (ãƒ—ãƒ­ã‚­ã‚·å®Ÿè¡Œ) ---
    try {
        // Base64ã‹ã‚‰å…ƒã®URLã«å¾©å…ƒ
        const targetFullUrl = decodeURIComponent(Buffer.from(queryUrl, 'base64').toString('utf-8'));
        const target = url.parse(targetFullUrl);

        // 404å¯¾ç­–ï¼šãƒ‘ã‚¹ãŒç©ºãªã‚‰ / ã‚’å…¥ã‚Œã‚‹
        const options = {
            protocol: target.protocol,
            hostname: target.hostname,
            port: target.port || (target.protocol === 'https:' ? 443 : 80),
            path: target.path || '/',
            method: req.method,
            headers: {
                ...req.headers,
                'host': target.hostname,
                'referer': target.protocol + '//' + target.hostname + '/',
                'accept-encoding': 'identity'
            }
        };

        const requestLib = target.protocol === 'https:' ? https : http;

        const proxyReq = requestLib.request(options, (proxyRes) => {
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’è§£é™¤ï¼ˆã“ã‚ŒãŒãªã„ã¨åˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³ã§è¡¨ç¤ºã§ããªã„ï¼‰
            const headers = { ...proxyRes.headers };
            delete headers['content-security-policy'];
            delete headers['x-frame-options'];
            
            res.writeHead(proxyRes.statusCode, headers);
            proxyRes.pipe(res);
        });

        proxyReq.on('error', (e) => {
            res.status(500).send("Proxy Request Error: " + e.message);
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«æµã™
        req.pipe(proxyReq);

    } catch (e) {
        res.status(400).send("URLãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: " + e.message);
    }
};

const http = require('http');
const https = require('https');
const url = require('url');

module.exports = async (req, res) => {
    const parsedUrl = url.parse(req.url, true);
    const queryUrl = parsedUrl.query.url;

    // --- 1. URLãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼šå…¥åŠ›ç”»é¢ï¼ˆHTMLï¼‰ã‚’è¡¨ç¤º ---
    if (!queryUrl) {
        res.setHeader('Content-Type', 'text/html; charset=UTF-8');
        return res.status(200).send(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Vercel Proxy</title>
                <style>
                    body { background: #121212; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
                    .box { background: #1e1e1e; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); width: 80%; max-width: 450px; text-align: center; }
                    input { width: 100%; padding: 15px; border-radius: 30px; border: none; outline: none; margin-bottom: 20px; font-size: 16px; box-sizing: border-box; background: #333; color: white; }
                    button { background: #0055ff; color: white; border: none; padding: 15px 40px; border-radius: 30px; cursor: pointer; font-weight: bold; width: 100%; font-size: 16px; }
                </style>
            </head>
            <body>
                <div class="box">
                    <h1>ğŸŒ Node Proxy</h1>
                    <input type="text" id="target" placeholder="google.com" spellcheck="false">
                    <button onclick="go()">ã‚µã‚¤ãƒˆã¸ç§»å‹•</button>
                    <p style="color:#555; font-size:12px; margin-top:15px;">URLã‚’å…¥åŠ›ã—ã¦Goã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
                </div>
                <script>
                    function go() {
                        const val = document.getElementById('target').value;
                        if(!val) return;
                        let targetUrl = val.startsWith('http') ? val : 'https://' + val;
                        // Vercelã®çµ¶å¯¾ãƒ‘ã‚¹ã‚’æŒ‡å®šï¼ˆã“ã“ãŒ404å›é¿ã®éµï¼‰
                        const encoded = btoa(encodeURIComponent(targetUrl));
                        window.location.href = '/api/proxy?url=' + encoded;
                    }
                    document.getElementById('target').onkeydown = (e) => { if(e.key === 'Enter') go(); };
                </script>
            </body>
            </html>
        `);
    }

    // --- 2. URLãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆï¼šãƒ—ãƒ­ã‚­ã‚·ã‚’å®Ÿè¡Œ ---
    try {
        const targetFullUrl = decodeURIComponent(Buffer.from(queryUrl, 'base64').toString('utf-8'));
        const target = url.parse(targetFullUrl);

        const options = {
            protocol: target.protocol,
            hostname: target.hostname,
            port: target.port || (target.protocol === 'https:' ? 443 : 80),
            path: target.path || '/',
            method: req.method,
            headers: {
                ...req.headers,
                'host': target.hostname,
                'referer': target.protocol + '//' + target.hostname + '/',
                'accept-encoding': 'identity'
            }
        };

        const requestLib = target.protocol === 'https:' ? https : http;

        const proxyReq = requestLib.request(options, (proxyRes) => {
            const headers = { ...proxyRes.headers };
            delete headers['content-security-policy'];
            delete headers['x-frame-options'];
            
            res.writeHead(proxyRes.statusCode, headers);
            proxyRes.pipe(res);
        });

        proxyReq.on('error', (e) => res.status(500).send("Proxy Error: " + e.message));
        req.pipe(proxyReq);

    } catch (e) {
        res.status(400).send("Invalid URL");
    }
};

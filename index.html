<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Portal</title>
    <style>
        body { 
            background: #f0f2f5; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
        }
        .card { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            width: 90%; 
            max-width: 400px; 
            text-align: center; 
        }
        h2 { color: #1c1e21; margin-bottom: 20px; font-weight: 600; }
        input { 
            width: 100%; 
            padding: 15px; 
            border: 2px solid #ddd; 
            border-radius: 10px; 
            font-size: 16px; 
            box-sizing: border-box; 
            outline: none; 
            transition: border-color 0.3s; 
        }
        input:focus { border-color: #007bff; }
        button { 
            width: 100%; 
            margin-top: 20px; 
            padding: 15px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: background 0.3s; 
        }
        button:hover { background: #0056b3; }
        .footer { margin-top: 20px; font-size: 12px; color: #888; }
    </style>
</head>
<body>
    <div class="card">
        <h2>Memo Search</h2>
        <form id="uv-form">
            <input type="text" id="uv-address" placeholder="URLを入力 (例: google.com)" autocomplete="off">
            <button type="submit" id="uv-btn">アクセス開始</button>
        </form>
        <div class="footer">Service Worker Mode</div>
    </div>

    <script src="/config.js"></script>
    <script src="/lib.js"></script>
    
    <script>
        const form = document.getElementById('uv-form');
        const address = document.getElementById('uv-address');

        form.onsubmit = async (e) => {
            e.preventDefault();
            
            let url = address.value.trim();
            if (!url) return;
            
            // プロトコル補完
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }

            const btn = document.getElementById('uv-btn');
            btn.innerText = '準備中...';
            btn.disabled = true;

            if ('serviceWorker' in navigator) {
                try {
                    // sw.js を登録 (スコープをルートに設定)
                    const reg = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    
                    // 登録完了を待つ
                    await navigator.serviceWorker.ready;

                    // iPadのSafari向けに一瞬ラグを作る
                    setTimeout(() => {
                        const encodedUrl = __uv$config.encodeUrl(url);
                        // 強制的にリダイレクト
                        window.location.href = '/service/' + encodedUrl;
                    }, 500);

                } catch (err) {
                    alert('Service Workerの起動に失敗しました: ' + err);
                    btn.innerText = 'アクセス開始';
                    btn.disabled = false;
                }
            } else {
                alert('お使いのブラウザはプロキシをサポートしていません。');
            }
        };

        // 古いキャッシュによる真っ白画面を回避する処理
        window.addEventListener('load', () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (let registration of registrations) {
                        // 異常なパスで登録されているSWがあれば解除
                        if (registration.scope.includes('/service/')) {
                            registration.unregister();
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
